<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="CGK-Utrecht West" 
      title_url="http://www.cgk-utrechtwest.nl/" 
      description="Overzicht van de diensten in de Christelijke Gereformeerde Kerk te Utrecht-West."
      author="R.Brouwer" 
      author_email="r-gg-cgk@corine-robert.nl">
   <Require feature="dynamic-height"/>
   <Require feature="setprefs"/>
   <Require feature="skins"/>
  </ModulePrefs>
  <UserPref name="jsondatalink" datatype="hidden" 
      required="true"
      default_value="http://info.cgk-utrechtwest.nl/cgk-utrechtwest.json" />
  <UserPref name="active_view" required="true" 
     display_name="Welke diensten?"
     datatype="enum"
     default_value="archief">
    <EnumValue value="volgende" display_value="Volgende" />
    <EnumValue value="archief" display_value="Archief" />
    <EnumValue value="toekomst" display_value="Komende weken" />
  </UserPref>  
  
 <Content type="html">
  <![CDATA[
    <div id="info_divs"></div><div id="player_div" ></div><div id="content_div"></div>
    <script type="text/javascript">
    function makeJSONRequest() {    
      var params = {};
      params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
      // This URL returns a JSON-encoded string that represents a JavaScript object
      var url = "http://info.cgk-utrechtwest.nl/cgk-utrechtwest.json";
      gadgets.io.makeRequest(url, response, params);
    };

    function padzero(i) {
      if (i<10) { i="0" + i; }
      return i; 
    }
      
    function play(url,info,infodivid) {
       url+='&autoPlay=true';
       document.getElementById(infodivid).style.display='';
	// 3 different players
//	html = info+'<br/>';
	// direct play mp3 (using mp3 functionality in browser)
//	html+='<object width="400" height="50"><param name="src" value="'+url+'"><param name="autoplay" value="true"><param name="controller" value="true"><param name="bgcolor" value="#FFFFFF"><embed width="400" height="50" autostart="true" loop="false" src="'+url+'"/></embed></object>';
	// use 1bit based flash player
//	html+='<div><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=10,0,0,0" width="30" height="30"><PARAM NAME=movie VALUE="http://www.strangecube.com/audioplay/online/audioplay.swf?file='+url+'&auto=yes&sendstop=yes&repeat=1&buttondir=http://www.strangecube.com/audioplay/online/alpha_buttons/negative&bgcolor=0xffffff&mode=playpause"><PARAM NAME=quality VALUE=high><PARAM NAME=wmode VALUE=transparent><embed src="http://www.strangecube.com/audioplay/online/audioplay.swf?file='+escape(url)+'&auto=yes&sendstop=yes&repeat=1&buttondir=http://www.strangecube.com/audioplay/online/alpha_buttons/negative&bgcolor=0xffffff&mode=playpause" quality=high wmode=transparent width="30" height="30" align="" TYPE="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed></object></div>';
	// use Google Reader based flash
       html = info+'<br/><object codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,0,0" height="27" width="400" align="middle" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000">';
       html+= '<param name="Movie" value="http://www.google.com/reader/ui/3523697345-audio-player.swf?audioUrl='+url+'">';
       html+= '<param name="Src" value="http://www.google.com/reader/ui/3523697345-audio-player.swf?audioUrl='+url+'">';
       html+= '<param name="AllowScriptAccess" value="false">';
       html+= '<embed type="application/x-shockwave-flash" src="http://www.google.com/reader/ui/3523697345-audio-player.swf?audioUrl='+url+'" allowscriptaccess="never" quality="best" bgcolor="#ffffff" wmode="window" flashvars="playerMode=embedded" pluginspage="http://www.macromedia.com/go/getflashplayer" height="27" width="400">';
       html+= '</object>';

      document.getElementById('player_div').innerHTML = html;
  
      html = '<a href="javascript:showdefault()">terug</a>';
      document.getElementById('content_div').innerHTML = html;
      gadgets.window.adjustHeight();
    }
    
    function showdefault() {
      document.getElementById('player_div').innerHTML = '';
      makeJSONRequest();
    }

    function response(obj) { 
      var months=new Array('januari','februari','maart','april','mei','juni','juli','augustus','september','oktober','november','december');
      var weekday=new Array('Zo','Ma','Di','Wo','Do','Vr','Za');
      var jsondata = obj.data;
      var html = "<table>";
      var ndag='';
      var info1='';
      var info2='';
      var preferences = new _IG_Prefs();
      var active_view=preferences.getString('active_view');
      var def_details='';
      if (active_view=='archief') {
	      html+="<tr><th colspan=2>datum</th><th>voorganger</th><th></th><th>tekst</th></tr>";
      } else {
	      html+="<tr><th colspan=2>datum</th><th>voorganger</th><th></th></tr>";
      }
      def_details='';
      infodiv='';
      
      var details1=def_details;
      var details2=def_details;
      // Process returned JS object as an associative array
      var currentday=new Date();
      for ( var i = 0; i < jsondata.length; i++ ) {
        d = new Date(jsondata[i].start_ts*1000);
        if ((active_view=='volgende') && (d<currentday)) { continue; };
        if ((active_view=='archief') && (currentday < d)) { continue; };
        if ((active_view=='toekomst') && (d < currentday )) { continue; };
        start_t=new Date(jsondata[i].start_ts*1000 + d.getTimezoneOffset()*1000*60);
        einde_t=new Date(jsondata[i].einde_ts*1000 + d.getTimezoneOffset()*1000*60); 
        cdag=weekday[start_t.getDay()]+" "+start_t.getDate()+" "+months[ start_t.getMonth() ]+" "+start_t.getFullYear();
        if (ndag!='' && ndag!=cdag) {
          if (active_view=='volgende' ) { break; };
          html += "<tr><td>"+ndag+"</td>"+info1+""+details1+"</tr>";
          html += "<tr><td>&nbsp;</td>"+info2+""+details2+"</tr>";
          info1='';
          details1=def_details;
          info2='';
          details2=def_details;
        }
        info = "<td align=\"right\"><b>"+start_t.getHours()+":"+padzero(start_t.getMinutes())+"</b> ";
        info+= "</td><td>"+jsondata[i].naam+"</td>";
	details='';
        if (typeof(jsondata[i].link)!='undefined') {
          playinfo = "U luistert naar de dienst van "+cdag+" "+info+"<br/>";
	  infodiv+= '<div id="infodiv_'+jsondata[i].start_ts+'" style="display:none">';
          infodiv+= "Thema: "+jsondata[i].omschrijving+" "+jsondata[i].thema+"<br/>";
          infodiv+= "Tekst: "+jsondata[i].tekst+"<br/>";
          infodiv+= "Liturgie:<br/><pre>"+jsondata[i].liturgie+"</pre>";
	  infodiv+= '</div>';
          details+='<td><a href="javascript:play(\''+escape(jsondata[i].link)+'\',\''+escape(playinfo)+'\',\''+escape('infodiv_'+jsondata[i].start_ts)+'\')">';
          details+='<img src="http://www.kerkomroep.nl/images/icoplay.jpg" border="0" alt="afspelen"></a></td>';
        } else {
          details+='<td></td>'; 
        }
        if (typeof(jsondata[i].omschrijving)!='undefined') {
	  details+= '<td>'+jsondata[i].omschrijving+'</td>';
	} else {
	  details+= '<td></td>';
	}
        if (active_view=='archief') {
	        if (typeof(jsondata[i].tekst)!='undefined') {
		  details+= '<td>'+jsondata[i].tekst+'</td>';
		} else {
		  details+= '<td></td>';
		}
        }
        if (ndag!=cdag) {
           info1=info;
           details1=details;
        } else {
           info2=info;
           details2=details;
        }
        ndag=cdag;
      }
      html += "<tr><td>"+ndag+"</td>"+info1+""+details1+"</tr>";
      html += "<tr><td>&nbsp;</td>"+info2+""+details2+"</tr>";
      document.getElementById('content_div').innerHTML = html;
      document.getElementById('info_divs').innerHTML = infodiv;
      gadgets.window.adjustHeight();
     };
     gadgets.util.registerOnLoadHandler(makeJSONRequest);
     </script>
  ]]>
  </Content>
</Module>
